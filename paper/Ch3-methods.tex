% Ch3-methods.tex
%
% vim: set ft=tex:
\section{Methods}

Broadly speaking, this section comes in two parts; first defining the more theoretical underpinnings
of the model used for simulation, followed by detail on the implementation in practice. There is
relatively little theory to discuss; much of it comes from prior work.\cite{Foy2018}

At a high level, we use a system of simultaneous equations to determine how the state of the
simulated lungs evolves, updating in discrete timesteps to give a close approximation to the way a
similar physical system would behave. \autoref{eq:volume-cons-naive} governs the
conservation of volume from one timestep to the next, which allows us to obtain greater numerial
stability than we might otherwise, e.g., with
$\text{volume}_{t+1} = \text{volume}_t + \text{flow} dt$.

Instead of a ``full'' fluid simulation (e.g., with the Navier-Stokes equations), we use a
one-dimensional simulation as shown in \citeauthor{Foy2018}, \citeyear{Foy2018}.

\subsection{Simultaneous Equations}

This section provides a summary and brief description of the four simultaneous equations that govern
the state of our system, the first of which is the following:

\begin{equation}
    P_{\text{parent}(i)} - P_i = R(i) Q_i
\end{equation}

\noindent
This specifies that the pressure differential between the distal end of branch $i$ and its parent
must equal the pressure from the resistance from the flow through this branch $i$. For the ``root''
branch, $P_{\text{parent}(i)}$ is the pressure at the trachea~--~typically atmospheric pressure.

The resistance term $R(i)$ is defined as following function, as given by Pedley et al. (1970):

\begin{equation*}
    R(i) = \frac{2 \mu L_i c}{\pi r_i^4} \left( \frac{4 \rho |Q_i|}{\mu \pi L_i} \right)^{\frac{1}{2}}
\end{equation*}

The parenthesized term corresponds to the Reynold's number of the flow, scaled by the ratio of the
diameter of the branch to its length $L_i$. $r_i$ is the radius of branch $i$, $\mu$ is the
viscosity of the air, and $c = 1.85$ is a correction constant.

The second equation ensures incompressibility; the flow through a bifurcation must equal the sum of
the flow through its children:

\begin{equation}
    Q_i = \sum Q_{\text{child}}
\end{equation}

\noindent
where each \textit{child} refers to any branch $c$ with $\text{parent}(c) = i$.

The third equation maintains that the volume of an acinar region changes with the flow into or out
of it for the given timestep:

\begin{equation}
    V_i^t = V_i^{t-1} + dt Q_i^t
\end{equation}

\noindent
where $dt$ is the timestep size, $t$ refers to the current timestep, and $V_i$ is the volume of the
acinar region of branch $i$.

The final equation defines the elastic force of each acinar region, relating the pressure it exerts
on its branch to the volume of the region itself and the pressure outside it:

\begin{equation} \label{eq:volume-cons-naive}
    P_i = \frac{1}{C_i} V_i + P_{pl}(t)
\end{equation}

\noindent
where $P_{pl}(t)$ is the pleural pressure (i.e. the ``pressure'' from the diaphragm, outside the
acinar region) at the current time and $C_i$ is the \textit{compliance} of the acinar region of
branch $i$. The pleural pressure changes over time to mimic human breathing patterns~--~hence why it
is parameterised by $t$.

\subsection{Modelling in the Abstract} \label{sec:modelling-in-the-abstract}

We use an \textit{implicit} Euler's method to model the system as it progresses: at each timestep,
our simulation updates its state to the value of an approximate solution to the system of equations
above. \autoref{eq:volume-cons-naive} provides the necessary bounds to make the method implicit,
giving us higher accuracy at the cost of implementation complexity.

To solve for an approximate solution at each timestep, we use Newton's method with $f_{\bm{S}}(\bm{x})$ as
defined below, iterating until $\norm{f_{\bm{S}}(\bm{x})}^2 \le tol$ and $\norm{dx}^2 \le tol$, with
a tolerance of $10^{-6}$. The two ``inputs''~--~$\bm{S}$ and $\bm{x}$~--~partition the state of the
model into the variables that are controlled externally (e.g.: pleural pressure, compliance) and
those that are calculated from the system state (e.g.: acinar volume, airflow). The definitions of
$\bm{x}$ and $f_{\bm{S}}$ are given by:

\begin{equation*}
    x = (P_i..., Q_i..., V_i...)
\end{equation*}

\begin{equation*}
    f_{\bm{S}}(\bm{x}) =
        \begin{bmatrix}
            P_{\text{parent}(i)} - P_i - R(i)Q_i \\
            \vdots \\
            Q_i - \sum Q_{\text{child}} \\
            \vdots \\
            V_i^t - V_i^{t-1} - dtQ_i^t \\
            \vdots \\
            P_i - P_{pl}(t) - \frac{1}{C_i} V_i \\
            \vdots \\
        \end{bmatrix}
\end{equation*}

Note that the values in $\bm{x}$ and equations in $f$ are repeated only as many times as fits; e.g.,
there are fewer acinar regions than total branches, so there are fewer components in $\bm{x}$ from
each $V_i$ than from each $Q_i$.

As $\bm{S}$ only exists in the abstract sense, we won't bother to define its structure; all that's
necessary to know is that it contains every variable referred to in $f$ that is not already given
explicitly by $\bm{x}$.

\breakpars

It's worth noting that in practice, the above definitions are only \textit{nearly} correct; a few
adjustments were made to the inputs and equations to mitigate limitations from floating-point
accuracy. These are discussed in the \hyperref[sec:units-and-numerical-stability]{next section}.

\subsection{Units \& Modified Equations for Numerical Stability} \label{sec:units-and-numerical-stability}

It is worth making explict the units used for each value in our simultaneous equations. After
careful consideration, these were considered to provide the best trade-off of familiar units and
those with values of magnitude close to one, where floating-point accuracy is maximized. As we will
see momentarily, the spread was still quite wide. The chosen units were:

{
    % Add a bit more spacing within the rows of the table
    \renewcommand{\arraystretch}{1.6}
    \begin{table}[h]
    \centering
    \begin{tabular}{ |c|c| }
        \hline
        Type of thing ??? & Units \\
        \hline \hline
        Distance & $\text{m}$ \\
        \hline
        Volume & $\text{m}^3$ \\
        \hline
        Flow velocity & $\frac{ \text{m}^3 }{ \text{s} }$ \\
        \hline
        Density & $\frac{ \text{kg} }{ \text{m}^3 }$ \\
        \hline
        Pressure & Pascals $\left( \frac{ \text{kg} }{ \text{m} \cdot \text{s}^2 } \right)$ \\
        \hline
        Compliance & $\frac{ \text{m}^3 }{ \text{Pascal} }$ $\left( \frac{ \text{m}^4 \cdot \text{s}^2 }{ \text{kg} } \right)$ \\
        \hline
        Resistance & $\frac{ \text{kg} }{ \text{m}^4 \cdot \text{s} }$ \\
        \hline
        Viscosity & $\frac{ \text{kg} }{ \text{m} \cdot \text{s} }$ \\
        \hline
    \end{tabular}
    \end{table}
}

One of the challenges with using these units is that some values are at a much greater magnitude
than the others. For example, the pressure inside each branch is close to atmospheric pressure~--~or
about $10^5$ Pascals, but pressure \textit{gradients} are typically much smaller.

In practice, this can mean that if the $dx$ from our Euler step is too small, the pressure won't
change; it doesn't have the necessary precision at that magnitude.

\breakpars

To mitigate this issue, we define two new values: $\hat{P}$ and $\hat{V}$, which are given by:

\begin{equation}
    \hat{P} = P - P_{\text{atm}}
\end{equation}

\noindent
where $P_{\text{atm}}$ is is atmospheric pressure; and:

\begin{align}
    \hat{V} & = V - V \vert_{P = P_{\text{atm}}} \\
            & = C (\hat{P} - P_{pl})
\end{align}

\noindent
Note that the definition of $\hat{V}$ would be the result of simply substituting $\hat{P}$ for $P$
in \ref{eq:volume-cons-naive}. Applying these substitutions gives the following
equations, equivalent to their counterparts above:

\begin{equation}
    \hat{P}_{\text{parent}} - \hat{P}_i = R(i) Q_i
\end{equation}

\begin{equation}
    Q_i = \sum Q_{\text{child}}
\end{equation}

\begin{equation}
    \hat{V}_i^t = \hat{V}_i^{t-1} + dt Q_i^t
\end{equation}

\begin{equation}
    \hat{P}_i = \frac{1}{C_i} \hat{V}_i + P_{pl}(t)
\end{equation}

Representing the pressure and volume by their \textit{offset} from values at atmospheric pressure
causes them to cluster much closer to zero~--~the magnitude of the mean is significantly decreased,
relative to the variance of the values. This of course greatly improves the accuracy of each Euler
step.

Note: The same substitutions also apply to our representations of the state of the model \& the
optimization function used for Newton's method, as shown in \autoref{sec:modelling-in-the-abstract}.

\subsection{Sparse Matrices}

A key observation that can aid in simulation speed is that we can represent the Jacobean of our
optimization function $f$ in $\mathcal{O}(n)$ space using sparse matrices~--~which is necessary to
allow simulation of the lungs up to a high depth without a quadratic blow-up in runtime.

\todo{
    There's a small disconnect between the set of algoithms we \textit{could} use for solving the
    system versus the actual set of algorithms that I can find packages implementing.

    So the remaining questions here are along the lines of: what are the typical constraints of
    algorithms to use here, and how does the existing structure of the matrices interact with that?

    My current thinking for this section is that it should talk about the available options for
    organizing the sparse matrices (particularly comparing with Foy, which arranges the array in a
    pattern that's not quite as conducive for sparse solving algorithms). This should probably be a
    side-by-side comparision with some fancy-ish figures, using the ones I've laid out below.

    There's some interesting points about how the structure of the equations (namely: there are
    always at least two variables) means that we ``naturally'' get an uppper/lower triangular
    matrix.
}

\begin{figure}[H]
    \centering
    \tightbox{\includegraphics[width=.5\textwidth]{figs/sparse/separate-big.png}}
    \caption{
        Values and equations separated by type (as currently implemented), i.e. $(P..., Q..., V...)$.
    }
\end{figure}

\begin{figure}[H]
    \centering
    \tightbox{\includegraphics[width=.5\textwidth]{figs/sparse/separate-rev-big.png}}
    \caption{
        What's \textit{actually} currently implemented- because of the way that we assign branch
        numbers. All placements of values and equations are reversed in their slots from the
        previous figure.
    }
\end{figure}

\begin{figure}[H]
    \centering
    \tightbox{\includegraphics[width=.5\textwidth]{figs/sparse/branchgroup-big.png}}
    \caption{
        All values and equations for each branch followed by the next, i.e. $(..., P_i,Q_i,V_i, ...)$.
    }
\end{figure}

\begin{figure}[H]
    \centering
    \tightbox{\includegraphics[width=.5\textwidth]{figs/sparse/q-branchgroup-big.png}}
    \caption{
        Like the one above, but the variable for a branch's flow is placed directly after its
        parent's variables, not with its own: i.e.
        $(..., P_i, Q_{\text{left}}, Q_{\text{right}}, ...)$
    }
\end{figure}

\subsection{Procedural Lung Generation \& Configuration}

As part of the simluation software developed for this paper, there are a number of configurable
parameters~--~primarily encapsulating the structure of the lungs and how they change over the course
of the simulation. Listing them exhaustively, the parameters are:

\begin{itemize}
\item Lung structure (the tree formed by the relationship between branches)
\item Branch length, as relative to the parent
\item Branch radius (healthy \& degraded), relative to the parent
\item Acinar region \textit{relative compliance} (healthy \& degraded)
\item Branch angles (only affects the lungs' appearance)
\item Keyframe-based scheduling to shift the lung state between healthy \& degraded
    \begin{itemize}
    \item Multiple interpolation functions to transition between keyframes
    \end{itemize}
\item Pleural pressure wave characteristics (initial value, mean, amplitude, and period)
\end{itemize}

The specification of ``healthy'' and ``degraded'' allows us to define and transition between two
states of the lungs, simulating the onset and treatment of the affects from many respiratory
illnesses. The speed of onset or recovery is controlled by the positioning of the keyframes, which
are binary ``healthy'' or ``degraded'' states. These states do not directly affect the simulation
state, i.e. the flow, pressure, and acinar volume within each branch. This does mean that, for
example, the pressure in constricting airways does not increase directly as a result of that
constriction, but we have considered the volume inside the branches themselves largely negligible.
The most important factor is that the volume within each acinar region is conserved, which
\textit{is} guaranteed, even across changing compliance.

\breakpars

It is also worth clarifying the meaning of \textit{relative compliance} in the list above. In order
to ensure that the total volume of the lungs remains consistent with human anatomy, the compliance
of each acinar region is linearly scaled so that the total volume from all acinar regions filled at
atmospheric pressure is 2.0 liters.

\todo{
    This should probably not be 2 liters; looking at the actual data, the starting volume of the
    lung doesn't really correspond to FRC \textit{or} FRC + tidal volume, so it should be closer.
    There's also the issue that the tidal volume that the simulation reports is \textit{much}, much
    less than what it should be~--~like... 40 milliliters kind of small.

    This \textit{probably} has something to do with the compliances being much smaller than what
    Foy's paper had, but I'm still really not sure why that was happening.
}

\breakpars

A comparison and analysis of transition interpolation functions is given in \autoref{sec:results},
alongside their definitions.

\breakpars

The details of the configuration format itself are outside the scope of this paper, but the
configurable values are described here to provide context for the parameters that were varied in the
experiments we report.
